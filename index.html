<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©couvrez votre Enn√©agramme</title>
    <style>
        /* --- Google Font (Optional - Add if internet connection available) --- */
        /* @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap'); */

        /* --- Reset & Base Styles --- */
        :root {
            --primary-color: #3B82F6; /* Blue-500 */
            --secondary-color: #F59E0B; /* Amber-500 */
            --background-color: #F3F4F6; /* Gray-100 */
            --card-bg-color: #FFFFFF; /* White */
            --text-color: #1F2937; /* Gray-800 */
            --text-muted-color: #6B7280; /* Gray-500 */
            --border-color: #E5E7EB; /* Gray-200 */
            --light-gray: #F9FAFB; /* Gray-50 */
            --medium-gray: #D1D5DB; /* Gray-300 */
            --dark-gray: #4B5563; /* Gray-600 */
            --danger-color: #EF4444; /* Red-500 */
            --success-color: #10B981; /* Emerald-500 */

            /* Type Colors - Slightly softer palette */
            --type1-color: #EF4444; /* Red-500 */
            --type2-color: #F59E0B; /* Amber-500 */
            --type3-color: #10B981; /* Emerald-500 */
            --type4-color: #6366F1; /* Indigo-500 */
            --type5-color: #3B82F6; /* Blue-500 */
            --type6-color: #6B7280; /* Gray-500 */
            --type7-color: #EC4899; /* Pink-500 */
            --type8-color: #8B5CF6; /* Violet-500 */
            --type9-color: #84CC16; /* Lime-500 */

            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; /* Add Inter first if imported */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px; /* Base font size */
        }

        body {
            font-family: var(--font-sans);
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align top */
            padding: 30px 15px;
            min-height: 100vh;
        }

        #app {
            background-color: var(--card-bg-color);
            padding: 30px 35px; /* Increased padding */
            border-radius: 12px; /* Softer radius */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.05); /* Softer shadow */
            max-width: 850px;
            width: 100%;
            overflow: hidden;
        }

        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-bottom: 1.25rem;
            font-weight: 600; /* Medium weight */
            text-align: center;
        }
        h1 { font-size: 2rem; margin-bottom: 1.5rem; }
        h2 { font-size: 1.75rem; color: var(--dark-gray); }
        h3 { font-size: 1.5rem; color: var(--text-color); margin-top: 2rem; }
        h4 {
            font-size: 1.1rem;
            color: var(--secondary-color);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid var(--border-color);
            text-align: left; /* Align subheadings left */
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-muted-color);
            text-align: justify; /* Justify text for cleaner look */
        }
        #home p { text-align: center; } /* Center paragraphs on home */

        button {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--card-bg-color);
            border: 1px solid transparent;
            padding: 12px 24px; /* Larger padding */
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s ease;
            margin: 5px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        button:hover {
            filter: brightness(1.1); /* Brighter on hover */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
         button:active {
            filter: brightness(0.95);
             transform: translateY(1px);
         }

        button.secondary {
            background-color: var(--secondary-color);
        }

        button.outline {
            background-color: var(--card-bg-color);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        button.outline:hover {
            background-color: var(--light-gray);
             filter: none; /* Override brightness filter for outline hover */
        }

        button:disabled {
            background-color: var(--medium-gray);
            color: var(--dark-gray);
            cursor: not-allowed;
            box-shadow: none;
             filter: grayscale(50%);
        }

        /* --- View Management --- */
        .view { display: none; }
        .view.active {
            display: block;
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Section Spacing --- */
        section > *:not(:last-child) {
            margin-bottom: 1.5rem; /* Consistent spacing */
        }
        .actions-container { /* Wrapper for button groups */
            display: flex;
            justify-content: center;
            gap: 15px; /* Space between buttons */
            flex-wrap: wrap;
            margin-top: 2rem;
        }


        /* --- Home --- */
        #home h1 + p { margin-top: -0.5rem; margin-bottom: 2rem;} /* Adjust spacing after H1 */
        #saved-result-info {
            margin-top: 2rem;
            padding: 15px;
            background-color: var(--light-gray);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9em;
            color: var(--text-muted-color);
            display: none; /* Initially hidden */
            text-align: center;
        }
         #saved-result-info p { margin-bottom: 0.8rem; text-align: center; }
         #saved-result-info button { margin-top: 0.5rem; }


        /* --- Test --- */
         #test h2 { margin-bottom: 1rem; }
         #test p:first-of-type { /* Progress text */
             text-align: center;
             color: var(--text-muted-color);
             margin-bottom: 0.5rem;
         }
        #test-progress-container {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 99px; /* Pill shape */
            margin-bottom: 2rem;
            overflow: hidden;
             height: 12px; /* Slightly thicker */
        }
        #test-progress {
            height: 100%;
            width: 0%;
            background-color: var(--secondary-color);
            transition: width 0.3s ease;
             border-radius: 99px;
        }
        #question-container {
            margin-bottom: 2rem;
            min-height: 250px;
        }
        .question-item {
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
         .question-item:last-child { border-bottom: none; }
        .question-item p {
            font-weight: 600; /* Bold question text */
            margin-bottom: 1rem;
            color: var(--text-color);
             text-align: left;
        }
        .likert-scale {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around; /* Even spacing */
            gap: 10px;
            padding: 10px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--light-gray);
        }
        .likert-scale label {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-muted-color);
            padding: 8px 5px;
            border-radius: 6px;
            min-width: 70px;
             transition: background-color 0.2s ease;
        }
        .likert-scale input[type="radio"] {
             margin-bottom: 6px;
             accent-color: var(--primary-color);
             transform: scale(1.1); /* Slightly larger radio */
        }
         .likert-scale label:hover {
             background-color: #e9ecef; /* Subtle hover on label */
         }
        .likert-scale input[type="radio"]:checked + span {
             font-weight: 600;
             color: var(--primary-color);
        }

        #test-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Vertically align buttons */
            margin-top: 2rem;
             padding-top: 1rem;
             border-top: 1px solid var(--border-color);
        }
        #test .actions-container { /* For the abandon button */
             margin-top: 1rem;
             justify-content: center;
        }


        /* --- Results --- */
        #results h2 { margin-bottom: 1rem; }
        #results-summary {
            text-align: center;
            margin-bottom: 2.5rem;
            padding: 20px;
            background-color: var(--light-gray);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
         #results-summary h2 {
             margin-bottom: 0.75rem;
             font-size: 1.5rem;
             color: var(--text-color); /* Less emphasis than main titles */
         }
         #results-summary h2 span { font-weight: 700; } /* Bold type name/number */
         #results-summary p { /* Wings info */
             color: var(--text-muted-color);
             font-size: 0.95rem;
             margin-bottom: 0;
         }
          #results h3 { /* Scores by type */
              font-size: 1.3rem;
              color: var(--text-color);
              margin-bottom: 1rem;
          }
        #results-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 220px; /* Increased height */
            border-bottom: 2px solid var(--medium-gray); /* Thicker base line */
            padding-bottom: 10px;
            margin-bottom: 2.5rem; /* More space after chart */
            position: relative;
        }
        .chart-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 9%; /* Width for bars */
            text-align: center;
            height: 100%;
            justify-content: flex-end;
        }
        .chart-bar {
            width: 100%;
            transition: height 0.6s cubic-bezier(0.25, 1, 0.5, 1); /* Smoother transition */
            border-radius: 5px 5px 0 0; /* Rounded top */
            position: relative;
            margin-bottom: 8px; /* Space for label */
        }
        .chart-bar::after { /* Tooltip */
            content: attr(data-score);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.85); /* Gray-800 with transparency */
            color: var(--card-bg-color);
            padding: 4px 8px; /* More padding */
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
        }
        .chart-bar:hover::after { opacity: 1; visibility: visible; }
        .chart-label {
            font-size: 0.9rem;
            color: var(--dark-gray);
            font-weight: 600;
        }
        #results-actions {
             display: flex;
             justify-content: center;
             gap: 15px;
             flex-wrap: wrap;
             margin-top: 2rem;
         }

        /* --- Types --- */
        #types h2 { margin-bottom: 2rem; }
        #type-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .type-button {
            padding: 10px; /* Square buttons */
            min-width: 50px;
            height: 50px;
            font-size: 1.2rem; /* Larger icon/number */
            font-weight: 700;
             line-height: 1; /* Center text vertically */
             display: flex;
             align-items: center;
             justify-content: center;
        }
        /* Color outline based on type */
        .type-button.type-color-1 { border-color: var(--type1-color); color: var(--type1-color); }
        .type-button.type-color-2 { border-color: var(--type2-color); color: var(--type2-color); }
        .type-button.type-color-3 { border-color: var(--type3-color); color: var(--type3-color); }
        .type-button.type-color-4 { border-color: var(--type4-color); color: var(--type4-color); }
        .type-button.type-color-5 { border-color: var(--type5-color); color: var(--type5-color); }
        .type-button.type-color-6 { border-color: var(--type6-color); color: var(--type6-color); }
        .type-button.type-color-7 { border-color: var(--type7-color); color: var(--type7-color); }
        .type-button.type-color-8 { border-color: var(--type8-color); color: var(--type8-color); }
        .type-button.type-color-9 { border-color: var(--type9-color); color: var(--type9-color); }

        .type-button:hover {
             opacity: 0.8;
             background-color: var(--light-gray);
         }
         /* Style for the currently selected type button */
         .type-button.selected {
             background-color: var(--primary-color); /* Use type color instead? */
             color: white;
             /* Example using type color: background-color: var(--current-type-color); */
         }


        #type-detail-content {
            margin-top: 2rem;
            padding: 25px; /* More padding */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            position: relative; /* For colored border */
             overflow: hidden; /* To contain the border */
             background-color: #fff; /* Ensure background */
        }
        /* Add colored left border based on JS */
        #type-detail-content::before {
             content: '';
             position: absolute;
             left: 0;
             top: 0;
             bottom: 0;
             width: 6px; /* Thickness of the border */
             background-color: var(--border-color); /* Default border color */
             transition: background-color 0.3s ease;
         }

        #type-detail-content h3:first-child {
            margin-top: 0;
             text-align: left; /* Align title left */
             margin-bottom: 1.5rem;
        }
         .type-detail-section p { text-align: left; } /* Align detail paragraphs left */
         .type-detail-section strong { color: var(--text-color); font-weight: 600; }

         /* Back button specific to type details */
         #hide-details-btn-container {
             text-align: center;
             margin-top: 2rem;
             padding-top: 1rem;
             border-top: 1px solid var(--border-color);
         }


        /* --- Comparison --- */
         #comparison h2 { margin-bottom: 1rem; }
         #comparison p:first-of-type { margin-bottom: 2rem; text-align: center; color: var(--text-muted-color);}
        #comparison-selectors {
            display: flex;
            justify-content: center; /* Center selectors */
            align-items: center;
            margin-bottom: 2rem;
            gap: 25px; /* More gap */
            flex-wrap: wrap;
        }
        #comparison-selectors label {
            margin-right: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
        #comparison-selectors select {
            padding: 10px 15px;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            min-width: 200px;
            background-color: var(--card-bg-color); /* Match background */
             font-size: 0.95rem;
             cursor: pointer;
        }
         #comparison .actions-container:nth-of-type(1) { /* Compare button */
             margin-top: 0;
             margin-bottom: 2rem;
         }
        #comparison-result {
            margin-top: 2rem;
            padding: 20px;
            background-color: var(--light-gray);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 60px;
        }
         #comparison-result h4 {
             color: var(--primary-color);
             text-align: center;
             margin-top: 0;
             margin-bottom: 1rem;
             border-bottom: none;
         }
         #comparison-result p { text-align: left; }
         #comparison-result em { font-size: 0.85rem; color: var(--text-muted-color); }
         #comparison .actions-container:nth-of-type(2) { /* Back button */
             margin-top: 2rem;
             padding-top: 1rem;
             border-top: 1px solid var(--border-color);
         }


        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
             #app { padding: 20px 25px; }
             h1 { font-size: 1.8rem; }
             h2 { font-size: 1.5rem; }
             h3 { font-size: 1.3rem; }
            button { padding: 10px 18px; font-size: 0.9rem; }
            .actions-container { gap: 10px; }

             #results-chart { height: 180px; }
             .chart-bar-container { width: 10%; }
            .chart-label { font-size: 0.8rem; }
            .chart-bar::after { font-size: 0.7rem; padding: 3px 6px; top: -22px; }

            #comparison-selectors { flex-direction: column; gap: 15px; align-items: stretch;}
            #comparison-selectors select { width: 100%; min-width: auto; }
        }

         @media (max-width: 480px) {
             body { padding: 15px 5px; }
             #app { padding: 15px; }
             h1 { font-size: 1.6rem; }
             h2 { font-size: 1.3rem; }
             h3 { font-size: 1.15rem; }
             button { padding: 9px 15px; font-size: 0.85rem; }
             .actions-container { gap: 8px; }

             .likert-scale label { min-width: 55px; font-size: 0.75rem; }
             .likert-scale { justify-content: center; gap: 5px; }

             #results-chart { height: 160px; }
             .chart-label { font-size: 0.7rem; }
             .chart-bar::after { display: none; } /* Hide tooltip on very small screens */

             #type-selection { gap: 8px; }
             .type-button { min-width: 45px; height: 45px; font-size: 1rem; }
             #type-detail-content { padding: 15px; }
         }

        /* Type specific background/border colors (Used by JS) */
        /* Backgrounds used for chart bars */
        .type-bg-1 { background-color: var(--type1-color); }
        .type-bg-2 { background-color: var(--type2-color); }
        .type-bg-3 { background-color: var(--type3-color); }
        .type-bg-4 { background-color: var(--type4-color); }
        .type-bg-5 { background-color: var(--type5-color); }
        .type-bg-6 { background-color: var(--type6-color); }
        .type-bg-7 { background-color: var(--type7-color); }
        .type-bg-8 { background-color: var(--type8-color); }
        .type-bg-9 { background-color: var(--type9-color); }

        /* Border colors used for type details */
        .type-border-1::before { background-color: var(--type1-color); }
        .type-border-2::before { background-color: var(--type2-color); }
        .type-border-3::before { background-color: var(--type3-color); }
        .type-border-4::before { background-color: var(--type4-color); }
        .type-border-5::before { background-color: var(--type5-color); }
        .type-border-6::before { background-color: var(--type6-color); }
        .type-border-7::before { background-color: var(--type7-color); }
        .type-border-8::before { background-color: var(--type8-color); }
        .type-border-9::before { background-color: var(--type9-color); }

         /* Text colors used for titles/highlights */
        .type-text-1 { color: var(--type1-color); }
        .type-text-2 { color: var(--type2-color); }
        .type-text-3 { color: var(--type3-color); }
        .type-text-4 { color: var(--type4-color); }
        .type-text-5 { color: var(--type5-color); }
        .type-text-6 { color: var(--type6-color); }
        .type-text-7 { color: var(--type7-color); }
        .type-text-8 { color: var(--type8-color); }
        .type-text-9 { color: var(--type9-color); }

    </style>
</head>
<body>
    <div id="app">
        <!-- ==== HOME VIEW ==== -->
        <section id="home" class="view active">
            <h1>Bienvenue sur l'Explorateur d'Enn√©agramme</h1>
            <p>L'Enn√©agramme est un syst√®me fascinant de compr√©hension de la personnalit√©. D√©couvrez votre type pour mieux vous conna√Ætre, am√©liorer vos relations et identifier des pistes de d√©veloppement personnel.</p>
            <div class="actions-container">
                <button id="start-test-btn">D√©marrer le Test</button>
                <button id="view-types-btn" class="secondary">Explorer les 9 Types</button>
                 <button id="view-comparison-btn" class="outline">Comparer les Types</button>
            </div>
             <div id="saved-result-info">
                <p>Un r√©sultat pr√©c√©dent a √©t√© trouv√© dans ce navigateur.</p>
                <button id="show-saved-result-btn" class="outline">Afficher mon dernier r√©sultat</button>
                <button id="clear-saved-result-btn" class="outline danger" style="border-color: var(--danger-color); color: var(--danger-color);">Effacer</button>
            </div>
        </section>

        <!-- ==== TEST VIEW ==== -->
        <section id="test" class="view">
            <h2>Questionnaire Enn√©agramme</h2>
            <p><span id="current-q-number">1</span> / <span id="total-q-number"></span></p>
            <div id="test-progress-container">
                <div id="test-progress"></div>
            </div>
            <div id="question-container"></div>
            <div id="test-navigation">
                <button id="prev-btn" class="outline" disabled>Pr√©c√©dent</button>
                <span> <!-- Spacer or status --> </span>
                <button id="next-btn">Suivant</button>
                 <button id="finish-btn" class="secondary" style="display: none;">Voir mes R√©sultats</button>
            </div>
             <div class="actions-container">
                 <button onclick="showView('home')" class="outline" style="border-color: var(--danger-color); color: var(--danger-color);">Abandonner & Retour Accueil</button>
             </div>
        </section>

        <!-- ==== RESULTS VIEW ==== -->
        <section id="results" class="view">
            <h2>Vos R√©sultats</h2>
            <div id="results-summary">
                 <h2>Votre type principal probable : <span id="main-type-name"></span> (<span id="main-type-number"></span>)</h2>
                 <p id="wings-info"></p>
            </div>

            <h3>Scores par type :</h3>
            <div id="results-chart"></div>

            <div id="results-actions" class="actions-container">
                <button id="view-details-btn">Voir les d√©tails de mon type</button>
                <button onclick="populateTypeSelection(); showView('types');" class="secondary">Explorer les autres types</button>
                <button onclick="resetTestAndShowHome()" class="outline">Refaire le test</button>
            </div>
        </section>

        <!-- ==== TYPES VIEW ==== -->
        <section id="types" class="view">
            <h2>Les 9 Types de l'Enn√©agramme</h2>
            <div id="type-selection"></div>
            <div id="type-detail-content" style="display: none;">
                 <!-- Type details loaded here -->
                 <!-- === AJOUT : Bouton Retour DANS les d√©tails === -->
                 <div id="hide-details-btn-container">
                     <button id="hide-details-btn" class="outline">Retour √† la s√©lection des types</button>
                 </div>
            </div>
             <!-- === AJOUT : Bouton Retour g√©n√©ral pour la vue Types === -->
             <div class="actions-container" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                  <button id="types-back-btn" class="outline">Retour</button>
             </div>
        </section>

         <!-- ==== COMPARISON VIEW ==== -->
        <section id="comparison" class="view">
            <h2>Comparaison Relationnelle</h2>
            <p>S√©lectionnez deux types pour d√©couvrir un aper√ßu de leur dynamique.</p>
             <div id="comparison-selectors">
                 <div>
                    <label for="compare-type1">Type 1 :</label>
                    <select id="compare-type1"></select>
                 </div>
                 <div>
                     <label for="compare-type2">Type 2 :</label>
                    <select id="compare-type2"></select>
                 </div>
            </div>
             <div class="actions-container">
                 <button id="compare-btn" class="primary">Comparer</button>
             </div>

            <div id="comparison-result"></div>

             <div class="actions-container">
                 <!-- === MODIFICATION : Bouton retour sp√©cifique === -->
                 <button onclick="showView('home')" class="outline">Retour √† l'accueil</button>
             </div>
        </section>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ---=== DATABASE (Keep existing data) ===---
             const enneagramData = {
                 1: { name: "Le Perfectionniste", color: "var(--type1-color)", icon: "üéØ", description: "Principl√©, d√©termin√©, contr√¥l√© et perfectionniste. Recherche l'int√©grit√© et l'am√©lioration.", strengths: "√âthique, fiable, productif, sage, id√©aliste, organis√©.", weaknesses: "Critique (soi et autres), jugement, rigidit√©, ressentiment, peur de l'erreur.", motivation: "√ätre bon, avoir raison, √™tre juste, √©viter la critique.", fear: "√ätre corrompu, mauvais, d√©fectueux, irresponsable.", stress: "Devient plus critique, rigide et moralisateur (comme un 4 malsain).", security: "Se d√©tend, devient plus spontan√© et accepte l'imperfection (comme un 7 sain).", growth: "Accepter l'imperfection (en soi et chez les autres), cultiver la s√©r√©nit√© et la patience, d√©velopper l'empathie.", tips: "Pratiquer la pleine conscience de la critique int√©rieure, c√©l√©brer les progr√®s (pas seulement la perfection), d√©l√©guer, apprendre √† se d√©tendre.", growthPath: 4, securityPath: 7 },
                 2: { name: "L'Altruiste", color: "var(--type2-color)", icon: "‚ù§Ô∏è", description: "Attentionn√©, g√©n√©reux, ax√© sur les relations, mais peut √™tre possessif ou manipulateur.", strengths: "Aimant, attentionn√©, g√©n√©reux, empathique, soutenant.", weaknesses: "Fiert√© (de ne pas avoir besoin d'aide), d√©pendance affective, manipulation indirecte, difficult√© √† dire non.", motivation: "√ätre aim√©, √™tre n√©cessaire, √™tre appr√©ci√©.", fear: "Ne pas √™tre aim√©, ne pas √™tre voulu, √™tre rejet√©.", stress: "Devient plus agressif, autoritaire et potentiellement manipulateur (comme un 8 malsain).", security: "Devient plus conscient de ses propres besoins et limites, plus authentique (comme un 4 sain).", growth: "Reconna√Ætre et exprimer ses propres besoins, fixer des limites saines, apprendre √† recevoir, aimer sans attente de retour.", tips: "Tenir un journal de ses besoins/sentiments, pratiquer √† dire 'non' poliment, demander de l'aide, s'offrir des moments pour soi.", growthPath: 8, securityPath: 4 },
                 3: { name: "Le Battant", color: "var(--type3-color)", icon: "‚≠ê", description: "Orient√© succ√®s, adaptable, efficace, mais peut √™tre vaniteux et trop centr√© sur l'image.", strengths: "Ambitieux, efficace, confiant, √©nergique, motivant, adaptable.", weaknesses: "Comp√©titif √† l'exc√®s, 'workaholic', vaniteux, peur de l'√©chec, d√©connexion des sentiments.", motivation: "√ätre valoris√©, admir√©, avoir du succ√®s, √™tre le meilleur.", fear: "Ne pas avoir de valeur intrins√®que, √©chouer, √™tre per√ßu comme incomp√©tent.", stress: "Se replie, devient apathique, perd sa motivation (comme un 9 malsain).", security: "Devient plus coop√©ratif, authentique et attach√© aux autres (comme un 6 sain).", growth: "Cultiver l'authenticit√© (sentiments vs image), valoriser les relations pour elles-m√™mes, ralentir, accepter l'√©chec comme apprentissage.", tips: "Identifier ses vraies valeurs (pas seulement celles qui r√©ussissent), planifier du temps 'off' sans objectif de performance, pratiquer l'√©coute active.", growthPath: 9, securityPath: 6 },
                 4: { name: "Le Romantique", color: "var(--type4-color)", icon: "üé®", description: "Introspectif, expressif, unique, mais peut √™tre m√©lancolique et auto-absorb√©.", strengths: "Cr√©atif, sensible, introspectif, authentique, empathique, profond.", weaknesses: "Lunatique, m√©lancolique, auto-absorb√©, envieux, sentiment d'incompl√©tude.", motivation: "√ätre unique, authentique, compris, trouver son identit√©.", fear: "Ne pas avoir d'identit√© propre, √™tre insignifiant, ordinaire, abandonn√©.", stress: "Devient excessivement d√©pendant, en demande d'attention, s'accroche aux autres (comme un 2 malsain).", security: "Devient plus objectif, engag√© dans l'action et moins submerg√© par les √©motions (comme un 1 sain).", growth: "Appr√©cier le pr√©sent et l'ordinaire, cultiver la gratitude, agir malgr√© l'humeur, √©quilibrer √©motion et raison.", tips: "Pratiquer la gratitude quotidienne, s'engager dans des actions cr√©atives concr√®tes, reconna√Ætre la valeur dans le 'commun', rester ancr√©.", growthPath: 2, securityPath: 1 },
                 5: { name: "L'Observateur", color: "var(--type5-color)", icon: "üß†", description: "Perspicace, curieux, ind√©pendant, mais peut √™tre d√©tach√© et isol√©.", strengths: "Analytique, perspicace, curieux, ind√©pendant, objectif, calme.", weaknesses: "D√©tach√© √©motionnellement, avare (temps, √©nergie, savoir), isol√©, peur de l'engagement.", motivation: "√ätre comp√©tent, capable, savoir, comprendre.", fear: "√ätre inutile, incapable, impuissant, envahi, submerg√© par les besoins des autres.", stress: "Devient hyperactif, dispers√©, recherche fr√©n√©tiquement des distractions (comme un 7 malsain).", security: "Devient plus confiant, engag√©, assertif et connect√© √† son corps (comme un 8 sain).", growth: "S'engager avec le monde et les √©motions, partager ses ressources (savoir, temps), connecter corps et esprit.", tips: "Pratiquer l'incarnation (sport, danse, nature), fixer des limites au temps de recherche, s'entra√Æner √† partager ses id√©es/sentiments, agir avant d'√™tre 'pr√™t'.", growthPath: 7, securityPath: 8 },
                 6: { name: "Le Loyaliste", color: "var(--type6-color)", icon: "üõ°Ô∏è", description: "Engag√©, responsable, orient√© s√©curit√©, mais peut √™tre anxieux et m√©fiant.", strengths: "Loyal, responsable, travailleur, pr√©voyant, courageux (face aux peurs).", weaknesses: "Anxieux, ind√©cis, m√©fiant, pessimiste, projette ses peurs.", motivation: "Avoir s√©curit√©, soutien, certitude.", fear: "√ätre sans soutien, abandonn√©, incapable de survivre seul, faire une erreur irr√©parable.", stress: "Devient comp√©titif, arrogant, cherche √† prouver sa valeur (comme un 3 malsain).", security: "Devient plus d√©tendu, confiant, optimiste et en paix (comme un 9 sain).", growth: "Faire confiance √† son propre jugement int√©rieur, g√©rer l'anxi√©t√© sans la laisser paralyser, accepter l'incertitude, agir malgr√© la peur.", tips: "Identifier les sc√©narios catastrophes vs r√©alit√©s, pratiquer la prise de d√©cision (m√™me petites), chercher des preuves de soutien (au lieu de preuves de danger), m√©ditation.", growthPath: 3, securityPath: 9 },
                 7: { name: "L'√âpicurien", color: "var(--type7-color)", icon: "üéâ", description: "Optimiste, spontan√©, polyvalent, mais peut √™tre dispers√© et √©viter la douleur.", strengths: "Optimiste, √©nergique, curieux, spontan√©, visionnaire, joyeux.", weaknesses: "Superficiel, impulsif, dispers√©, √©vite la douleur et l'ennui, difficult√© √† s'engager.", motivation: "√ätre satisfait, content, libre, √©viter la souffrance et la limitation.", fear: "√ätre priv√©, pi√©g√© dans la souffrance ou l'ennui, manquer quelque chose d'important.", stress: "Devient critique, perfectionniste, rigide (comme un 1 malsain).", security: "Devient plus concentr√©, profond, capable d'introspection et d'engagement (comme un 5 sain).", growth: "Accepter et traverser la douleur et l'ennui, s'engager en profondeur (projets, relations), trouver la joie dans la simplicit√©, appr√©cier le pr√©sent.", tips: "Pratiquer la pleine conscience, finir les projets commenc√©s, explorer volontairement les √©motions difficiles, limiter les options.", growthPath: 1, securityPath: 5 },
                 8: { name: "Le Protecteur", color: "var(--type8-color)", icon: "üëë", description: "Puissant, assertif, protecteur, mais peut √™tre contr√¥lant et intimidant.", strengths: "Protecteur, d√©cisif, volontaire, √©nergique, juste, leader naturel.", weaknesses: "Contr√¥lant, dominateur, insensible (surtout √† la vuln√©rabilit√©), vengeur, excessif.", motivation: "Se prot√©ger (et prot√©ger les siens), contr√¥ler son environnement, √™tre fort.", fear: "√ätre contr√¥l√©, bless√©, faible, vuln√©rable, trahi.", stress: "Se retire, devient secret, craintif et isol√© (comme un 5 malsain).", security: "Devient plus attentionn√©, ouvert de c≈ìur, utilise sa force pour soutenir (comme un 2 sain).", growth: "D√©velopper la vuln√©rabilit√©, reconna√Ætre l'impact de sa force, √©couter les autres, utiliser sa puissance au service des autres (pas seulement pour le contr√¥le).", tips: "Pratiquer l'√©coute active, remarquer sa r√©activit√© physique √† la vuln√©rabilit√© (la sienne ou celle des autres), s'excuser sinc√®rement, choisir ses combats.", growthPath: 5, securityPath: 2 },
                 9: { name: "Le M√©diateur", color: "var(--type9-color)", icon: "‚òÆÔ∏è", description: "Paisible, agr√©able, r√©ceptif, mais peut √™tre complaisant et √©viter les conflits.", strengths: "Accommodant, diplomate, patient, stable, inclusif, apaisant.", weaknesses: "Procrastinateur, ind√©cis, passif-agressif, t√™tu (inertie), difficult√© √† identifier ses propres besoins/col√®re.", motivation: "Maintenir la paix int√©rieure et l'harmonie ext√©rieure, √©viter les conflits.", fear: "Perte, s√©paration, conflit, tension, √™tre ignor√©.", stress: "Devient anxieux, inquiet, submerg√© (comme un 6 malsain).", security: "Devient plus affirm√©, √©nergique, orient√© objectifs (comme un 3 sain).", growth: "S'affirmer, reconna√Ætre et accepter sa propre col√®re comme √©nergie, d√©finir ses priorit√©s, agir pour ses propres d√©sirs.", tips: "Identifier ses propres d√©sirs (m√™me petits), pratiquer l'affirmation de soi ('Je veux...', 'Je pense...'), reconna√Ætre les signes physiques de la col√®re/tension, agir par petits pas.", growthPath: 6, securityPath: 3 }
             };
            const questions = [ /* Garder les m√™mes questions qu'avant */
                { id: 1, text: "J'ai des principes forts et je m'efforce de les respecter.", type: 1 },{ id: 2, text: "Je suis souvent critique envers moi-m√™me ou les autres quand les choses ne sont pas bien faites.", type: 1 },{ id: 3, text: "L'organisation et l'ordre sont importants pour moi.", type: 1 },{ id: 4, text: "J'aime aider les autres et me sentir n√©cessaire.", type: 2 },{ id: 5, text: "J'ai parfois du mal √† reconna√Ætre mes propres besoins.", type: 2 },{ id: 6, text: "Exprimer ma gratitude et mon affection est naturel pour moi.", type: 2 },{ id: 7, text: "Le succ√®s et la reconnaissance sont des moteurs importants pour moi.", type: 3 },{ id: 8, text: "Je suis efficace et j'aime atteindre mes objectifs.", type: 3 },{ id: 9, text: "Je m'adapte facilement pour plaire ou impressionner.", type: 3 },{ id: 10, text: "Je me sens souvent diff√©rent des autres, unique.", type: 4 },{ id: 11, text: "Mes √©motions sont intenses et importantes pour moi.", type: 4 },{ id: 12, text: "Je recherche l'authenticit√© et la profondeur dans ma vie.", type: 4 },{ id: 13, text: "J'ai besoin de comprendre le monde qui m'entoure en d√©tail.", type: 5 },{ id: 14, text: "J'appr√©cie mon temps seul pour r√©fl√©chir et recharger mes batteries.", type: 5 },{ id: 15, text: "Je pr√©f√®re observer avant de participer.", type: 5 },{ id: 16, text: "La s√©curit√© et la loyaut√© sont tr√®s importantes pour moi.", type: 6 },{ id: 17, text: "J'ai tendance √† imaginer les pires sc√©narios possibles.", type: 6 },{ id: 18, text: "Je cherche souvent l'avis des autres avant de prendre une d√©cision.", type: 6 },{ id: 19, text: "J'aime explorer de nouvelles options et exp√©riences.", type: 7 },{ id: 20, text: "J'essaie d'√©viter les sentiments n√©gatifs et la douleur.", type: 7 },{ id: 21, text: "Je suis g√©n√©ralement optimiste et plein d'√©nergie.", type: 7 },{ id: 22, text: "Je prends les devants et n'h√©site pas √† exprimer mon opinion.", type: 8 },{ id: 23, text: "Je prot√®ge les personnes qui me sont ch√®res.", type: 8 },{ id: 24, text: "J'aime avoir le contr√¥le des situations.", type: 8 },{ id: 25, text: "Je cherche √† √©viter les conflits et √† maintenir l'harmonie.", type: 9 },{ id: 26, text: "J'ai parfois du mal √† savoir ce que je veux vraiment.", type: 9 },{ id: 27, text: "Je peux voir tous les points de vue dans une situation.", type: 9 },
            ];
            const relationshipMatrix = { /* Garder la matrice enrichie pr√©c√©dente */
                "1-1": "Partage de valeurs √©lev√©es, discipline mutuelle. Risque de critiques r√©ciproques excessives et de rigidit√©.","1-2": "Le 1 apporte la structure, le 2 la chaleur humaine. Le 1 peut trouver le 2 trop √©motif ou indirect, le 2 peut se sentir insuffisamment appr√©ci√© ou critiqu√© par le 1.","1-3": "Focalisation sur l'efficacit√© et l'action. Peuvent √™tre une √©quipe tr√®s productive. Risque de n√©gliger les aspects √©motionnels et relationnels.","1-4": "Le 1 est pratique, le 4 est id√©aliste/√©motionnel. Attraction possible par les diff√©rences, mais risque d'incompr√©hension mutuelle (logique vs sentiment).","1-5": "Combinaison de rigueur (1) et d'analyse (5). Peuvent collaborer sur des projets intellectuels. Risque de d√©tachement √©motionnel excessif.","1-6": "Partage d'un sens du devoir et de la responsabilit√©. Le 1 peut trouver le 6 trop anxieux, le 6 peut trouver le 1 trop critique ou rigide.","1-7": "Contraste entre la discipline du 1 et la spontan√©it√© du 7. Le 1 peut aider le 7 √† se structurer, le 7 peut aider le 1 √† se d√©tendre. Risque fort de jugement (1->7) et de sentiment d'√™tre limit√© (7->1).","1-8": "Alliance de force et de principes. Peuvent √™tre puissants ensemble pour une cause. Risque de lutte pour le contr√¥le et d'insensibilit√© mutuelle.","1-9": "Le 1 apporte l'ordre, le 9 la paix. Peuvent se stabiliser. Le 1 peut reprocher au 9 son inaction, le 9 peut trouver le 1 trop exigeant.","2-2": "Tr√®s centr√©s sur la relation et l'aide. Risque de n√©gliger leurs propres besoins et de devenir co-d√©pendants.","2-3": "Le 2 soutient le succ√®s du 3, le 3 appr√©cie l'admiration du 2. Risque que la relation devienne superficielle ou bas√©e sur l'image.","2-4": "Forte connexion √©motionnelle possible. Le 2 apporte le soutien, le 4 la profondeur. Risque de montagnes russes √©motionnelles et de d√©pendance affective.","2-5": "Le 2 tente de 'r√©chauffer' le 5, le 5 peut se sentir envahi. Le 5 apporte l'objectivit√©, le 2 la connexion. N√©cessite beaucoup de respect des limites.","2-6": "Le 2 rassure le 6 anxieux, le 6 appr√©cie la loyaut√© du 2. Risque de d√©pendance mutuelle et de difficult√© √† g√©rer les conflits ouverts.","2-7": "Le 2 est attir√© par la joie du 7, le 7 par la g√©n√©rosit√© du 2. Le 2 peut se sentir n√©glig√©, le 7 peut se sentir √©touff√© par les attentes.","2-8": "Le 2 admire la force du 8, le 8 appr√©cie le soutien du 2. Dynamique protectrice. Risque de contr√¥le (8) et de manipulation affective (2).","2-9": "Relation douce et attentionn√©e. Le 2 prend soin, le 9 maintient l'harmonie. Risque d'√©vitement des probl√®mes et de manque d'affirmation.","3-3": "Tr√®s ax√©s sur l'image et le succ√®s. Peuvent √™tre un 'power couple'. Risque de comp√©tition et de manque d'authenticit√© √©motionnelle.","3-4": "Le 3 est orient√© action/image, le 4 authenticit√©/√©motion. Le 4 peut trouver le 3 superficiel, le 3 peut trouver le 4 trop lunatique. Attraction possible mais d√©fi d'int√©gration.","3-5": "Focalisation sur la comp√©tence et l'efficacit√©. Le 3 ex√©cute, le 5 analyse. Peuvent bien travailler ensemble. Risque de n√©gliger la connexion humaine.","3-6": "Le 3 apporte la confiance, le 6 la prudence. Peuvent s'√©quilibrer si le 3 ne m√©prise pas les doutes du 6 et si le 6 ne freine pas trop le 3.","3-7": "Tr√®s √©nergique, orient√© vers l'action, les projets et les nouvelles exp√©riences. Le 3 apporte l'objectif, le 7 l'enthousiasme. S'encouragent mutuellement. Risque d'√©viter les probl√®mes de fond, la profondeur √©motionnelle ou l'engagement durable.","3-8": "Combinaison d'ambition (3) et de puissance (8). Tr√®s forts pour atteindre des objectifs concrets. Risque de conflit d'ego et de lutte pour le leadership.","3-9": "Le 3 est actif, le 9 est r√©ceptif. Le 9 admire l'√©nergie du 3, le 3 appr√©cie le calme du 9. Le 3 peut pousser le 9, mais risque de le surmener ou de ne pas le voir.","4-4": "Profonde connexion √©motionnelle et compr√©hension mutuelle unique. Risque de se perdre dans la m√©lancolie, le drame ou l'isolement √† deux.","4-5": "Monde int√©rieur riche (4) rencontre monde intellectuel riche (5). Peuvent s'appr√©cier mutuellement. Le 4 peut d√©sirer plus d'expression √©motionnelle, le 5 plus d'espace.","4-6": "Le 4 apporte la profondeur √©motionnelle, le 6 la loyaut√© et l'engagement. Le 4 peut trouver le 6 trop conventionnel/anxieux, le 6 peut trouver le 4 trop instable.","4-7": "Le 4 cherche la profondeur, le 7 la nouveaut√©/le plaisir. Peuvent s'inspirer mutuellement (cr√©ativit√©/joie). Risque que le 7 fuie l'intensit√© du 4, et que le 4 trouve le 7 superficiel.","4-8": "Le 4 appr√©cie l'authenticit√© et la force du 8, le 8 peut √™tre intrigu√© par la profondeur du 4. Risque de confrontations intenses dues √† leur nature passionn√©e.","4-9": "Le 4 cherche l'intensit√© et l'unicit√©, le 9 recherche la paix et l'harmonie. Le 9 peut apaiser le 4, le 4 peut aider le 9 √† se connecter √† ses passions. Risque que le 4 trouve le 9 trop passif et que le 9 trouve le 4 trop dramatique ou exigeant.","5-5": "Beaucoup d'espace personnel, compr√©hension mutuelle du besoin de retrait et d'analyse. Risque d'isolement excessif et de n√©gligence de la vie pratique ou √©motionnelle.","5-6": "Le 5 apporte l'analyse, le 6 la planification des risques. Peuvent former une √©quipe prudente et comp√©tente. Le 5 peut trouver le 6 trop anxieux, le 6 peut trouver le 5 trop d√©tach√©.","5-7": "Combinaison d'exploration mentale (5) et d'exploration exp√©rientielle (7). Stimulant intellectuellement. Risque que le 7 trouve le 5 trop retir√© et que le 5 trouve le 7 trop dispers√©.","5-8": "Alliance de la strat√©gie (5) et de la puissance (8). Peuvent √™tre tr√®s efficaces ensemble pour des objectifs clairs. Risque de lutte de pouvoir intellectuel vs action, ou de manque de chaleur.","5-9": "Le 5 respecte l'autonomie du 9, le 9 appr√©cie le calme du 5. Relation peu exigeante. Risque de passivit√© et de manque d'engagement mutuel.","6-6": "Partage d'une recherche de s√©curit√© et de loyaut√©. Grande compr√©hension mutuelle des angoisses. Risque de rester bloqu√©s dans l'ind√©cision ou la m√©fiance.","6-7": "Le 6 apporte la prudence, le 7 l'optimisme. Peuvent s'√©quilibrer. Le 6 peut s'inqui√©ter de l'impulsivit√© du 7, le 7 peut se sentir frein√© par l'anxi√©t√© du 6.","6-8": "Le 6 cherche un protecteur (8), le 8 aime prot√©ger (6). Relation bas√©e sur la force et la loyaut√©. Risque que le 8 devienne trop dominant et le 6 trop d√©pendant.","6-9": "Recherche commune de s√©curit√© (6) et de confort (9). Peuvent cr√©er un environnement stable et pr√©visible. Risque d'inertie, de procrastination et d'√©vitement des conflits n√©cessaires.","7-7": "Beaucoup d'√©nergie, d'optimisme et de recherche de plaisir. Tr√®s amusant au d√©but. Risque d'√©viter les responsabilit√©s, les √©motions difficiles et l'engagement profond.","7-8": "Combinaison d'√©nergie et d'assertivit√©. Tr√®s actifs et entreprenants. Risque de confrontations explosives et de difficult√© √† ralentir.","7-9": "Le 7 apporte l'√©nergie et l'optimisme, le 9 la paix et l'acceptation. Le 9 peut stabiliser le 7, le 7 peut dynamiser le 9. Risque que le 7 s'ennuie et que le 9 se sente d√©pass√©.","8-8": "Relation intense, passionn√©e et directe. Respect mutuel de la force. Risque de luttes de pouvoir constantes et de manque de vuln√©rabilit√©.","8-9": "Le 8 prend les devants, le 9 suit et apaise. Le 8 appr√©cie le calme du 9, le 9 la force protectrice du 8. Risque que le 8 domine excessivement et que le 9 perde sa voix.","9-9": "Relation tr√®s paisible, confortable et harmonieuse. Compr√©hension mutuelle du besoin de tranquillit√©. Risque majeur d'inertie, de non-dits et de n√©gligence des probl√®mes."
             };

            // ---=== APPLICATION STATE ===---
            let currentView = 'home';
            let currentViewTarget = null; // Stores the element for the current view
            let navigationHistory = ['home']; // Simple history stack
            let currentQuestionIndex = 0;
            const questionsPerPage = 5;
            let userAnswers = {};
            let scores = {};
            let userResult = null;


            // ---=== DOM ELEMENTS ===---
            const views = document.querySelectorAll('.view');
            const appContainer = document.getElementById('app');
            // Home
            const startTestBtn = document.getElementById('start-test-btn');
            const viewTypesBtn = document.getElementById('view-types-btn');
            const viewComparisonBtn = document.getElementById('view-comparison-btn');
            const savedResultInfo = document.getElementById('saved-result-info');
            const showSavedResultBtn = document.getElementById('show-saved-result-btn');
            const clearSavedResultBtn = document.getElementById('clear-saved-result-btn'); // Added
            // Test
            const questionContainer = document.getElementById('question-container');
            const progressBar = document.getElementById('test-progress');
            const currentQNumberSpan = document.getElementById('current-q-number');
            const totalQNumberSpan = document.getElementById('total-q-number');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const finishBtn = document.getElementById('finish-btn');
            // Results
            const mainTypeNameSpan = document.getElementById('main-type-name');
            const mainTypeNumberSpan = document.getElementById('main-type-number');
            const wingsInfoP = document.getElementById('wings-info');
            const resultsChartDiv = document.getElementById('results-chart');
            const viewDetailsBtn = document.getElementById('view-details-btn');
            // Types
            const typeSelectionDiv = document.getElementById('type-selection');
            const typeDetailContentDiv = document.getElementById('type-detail-content');
             const hideDetailsBtn = document.getElementById('hide-details-btn'); // Added
             const typesBackBtn = document.getElementById('types-back-btn'); // Added
             // Comparison
            const compareType1Select = document.getElementById('compare-type1');
            const compareType2Select = document.getElementById('compare-type2');
            const compareBtn = document.getElementById('compare-btn');
            const comparisonResultDiv = document.getElementById('comparison-result');


            // ---=== FUNCTIONS ===---

            // === MODIFICATION : Improved View Management ===
            function showView(viewId, isBackAction = false) {
                //console.log(`Navigating to: ${viewId}, Is Back: ${isBackAction}, History: ${navigationHistory}`);

                const targetView = document.getElementById(viewId);
                if (!targetView) {
                    console.error("View not found:", viewId);
                    showView('home'); // Fallback
                    return;
                }

                // Update history only if it's a forward navigation
                if (!isBackAction) {
                     // Prevent adding the same view consecutively
                     if (navigationHistory[navigationHistory.length - 1] !== viewId) {
                         navigationHistory.push(viewId);
                     }
                }
                 // Limit history size (optional)
                 // if (navigationHistory.length > 10) navigationHistory.shift();

                views.forEach(view => view.classList.remove('active'));
                targetView.classList.add('active');
                currentView = viewId;
                 currentViewTarget = targetView; // Store the element

                window.scrollTo(0, 0);
            }

             function goBack() {
                 // Remove the current view from history
                 if (navigationHistory.length > 1) {
                     navigationHistory.pop();
                     const previousViewId = navigationHistory[navigationHistory.length - 1];
                     //console.log("Going back to:", previousViewId);
                     showView(previousViewId, true); // Navigate back without adding to history
                 } else {
                     //console.log("No more history, going home.");
                     showView('home', true); // Fallback to home if history is empty or only has one entry
                 }
             }
            // === FIN MODIFICATION ===


            // --- Test Functions ---
            function startTest() {
                currentQuestionIndex = 0;
                userAnswers = {}; scores = {}; userResult = null;
                localStorage.removeItem('enneagramResult');
                savedResultInfo.style.display = 'none';
                totalQNumberSpan.textContent = questions.length;
                displayCurrentQuestions();
                updateProgress();
                 navigationHistory = ['home']; // Reset history for new test
                showView('test');
                nextBtn.style.display = 'inline-block'; finishBtn.style.display = 'none';
            }

             function displayCurrentQuestions() { /* (No changes needed here) */
                questionContainer.innerHTML = '';
                const start = currentQuestionIndex;
                const end = Math.min(start + questionsPerPage, questions.length);
                currentQNumberSpan.textContent = start + 1;

                for (let i = start; i < end; i++) {
                    const q = questions[i];
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('question-item');
                    questionDiv.innerHTML = `
                        <p>${i + 1}. ${q.text}</p>
                        <div class="likert-scale" data-question-id="${q.id}">
                            <label><input type="radio" name="q${q.id}" value="1"><span>Pas du tout<br>d'accord</span></label>
                            <label><input type="radio" name="q${q.id}" value="2"><span>Plut√¥t pas<br>d'accord</span></label>
                            <label><input type="radio" name="q${q.id}" value="3"><span>Neutre</span></label>
                            <label><input type="radio" name="q${q.id}" value="4"><span>Plut√¥t<br>d'accord</span></label>
                            <label><input type="radio" name="q${q.id}" value="5"><span>Tout √† fait<br>d'accord</span></label>
                        </div>`;
                    questionContainer.appendChild(questionDiv);
                    if (userAnswers[q.id]) {
                        const savedInput = questionDiv.querySelector(`input[name="q${q.id}"][value="${userAnswers[q.id]}"]`);
                        if(savedInput) savedInput.checked = true;
                    }
                }
                questionContainer.removeEventListener('change', handleAnswerChange);
                questionContainer.addEventListener('change', handleAnswerChange);
                updateNavigationButtons();
            }

             function handleAnswerChange(event) { /* (No changes needed here) */
                if (event.target.type === 'radio' && event.target.name.startsWith('q')) {
                    const questionId = parseInt(event.target.name.substring(1));
                    userAnswers[questionId] = parseInt(event.target.value);
                }
            }

             function saveCurrentPageAnswers() { /* (No changes needed here) */
                 let allAnsweredOnPage = true;
                 const start = currentQuestionIndex;
                 const end = Math.min(start + questionsPerPage, questions.length);
                 for (let i = start; i < end; i++) {
                     if (!userAnswers[questions[i].id]) {
                         allAnsweredOnPage = false;
                         break;
                     }
                 }
                 return allAnsweredOnPage;
             }

             function nextQuestions() { /* (No changes needed here) */
                 saveCurrentPageAnswers(); // Save answers on page
                 currentQuestionIndex += questionsPerPage;
                 if (currentQuestionIndex >= questions.length) calculateResults();
                 else { displayCurrentQuestions(); updateProgress(); }
             }

             function previousQuestions() { /* (No changes needed here) */
                 saveCurrentPageAnswers();
                 currentQuestionIndex -= questionsPerPage;
                 if (currentQuestionIndex < 0) currentQuestionIndex = 0;
                 displayCurrentQuestions(); updateProgress();
             }

             function updateNavigationButtons() { /* (No changes needed here) */
                 prevBtn.disabled = currentQuestionIndex === 0;
                 const isLastPage = (currentQuestionIndex + questionsPerPage) >= questions.length;
                 nextBtn.style.display = isLastPage ? 'none' : 'inline-block';
                 finishBtn.style.display = isLastPage ? 'inline-block' : 'none';
             }

             function updateProgress() { /* (No changes needed here) */
                 const progressPercentage = Math.min(100, ((currentQuestionIndex + questionsPerPage) / questions.length) * 100); // Progress based on *next* page start
                 progressBar.style.width = `${progressPercentage}%`;
             }

             function calculateResults() { /* (Keep improved version from previous step) */
                if (!saveCurrentPageAnswers()) {
                     alert("Veuillez r√©pondre √† toutes les questions de la derni√®re page.");
                     return;
                 }
                scores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
                let answeredQuestionsCount = 0;
                for (const q of questions) {
                    if (userAnswers[q.id] !== undefined && userAnswers[q.id] !== null) {
                         scores[q.type] += userAnswers[q.id];
                        answeredQuestionsCount++;
                     } else { console.warn(`Q ${q.id} non r√©pondue.`); }
                }
                if (answeredQuestionsCount < questions.length * 0.8) {
                    alert("Pas assez de r√©ponses pour un r√©sultat fiable."); return;
                }
                let mainType = -1, maxScore = -1, tiedTypes = [];
                for (const type in scores) {
                    if (scores[type] > maxScore) { maxScore = scores[type]; mainType = parseInt(type); tiedTypes = [mainType]; }
                    else if (scores[type] === maxScore) { tiedTypes.push(parseInt(type)); }
                }
                let wings = [];
                if (mainType !== -1) {
                    const w1Type = mainType === 1 ? 9 : mainType - 1, w2Type = mainType === 9 ? 1 : mainType + 1;
                    const w1Score = scores[w1Type] || 0, w2Score = scores[w2Type] || 0;
                    const threshold = maxScore * 0.65;
                    if (w1Score >= threshold && w1Score > w2Score) wings.push(w1Type);
                    else if (w2Score >= threshold && w2Score > w1Score) wings.push(w2Type);
                    else if (w1Score >= threshold && w2Score >= threshold) {
                        if (Math.abs(w1Score - w2Score) <= 2) { wings.push(w1Type); wings.push(w2Type); }
                        else if (w1Score > w2Score) wings.push(w1Type); else wings.push(w2Type);
                    }
                }
                userResult = { mainType, wings, scores, tiedTypes };
                saveToLocalStorage();
                displayResults();
             }

             function saveToLocalStorage() { /* (No changes needed) */
                 if (userResult) { try { localStorage.setItem('enneagramResult', JSON.stringify(userResult)); } catch (e) { console.error("LS Save Fail", e); } }
             }
             function loadFromLocalStorage() { /* (No changes needed) */
                 try {
                     const saved = localStorage.getItem('enneagramResult');
                     if (saved) { userResult = JSON.parse(saved); return userResult && userResult.mainType && userResult.scores; }
                 } catch (e) { console.error("LS Load Fail", e); localStorage.removeItem('enneagramResult'); } return false;
             }


            // --- Results Functions ---
            function displayResults() { /* (Keep improved version) */
                if (!userResult) return;
                 const { mainType, wings, scores, tiedTypes } = userResult;
                const resultSummaryH2 = document.querySelector('#results-summary h2');

                if (mainType !== -1) {
                     let typeName = enneagramData[mainType].name;
                     let typeNumber = mainType;
                     resultSummaryH2.innerHTML = `Votre type principal probable : <span class="type-text-${mainType}" style="font-weight: 700;">${typeName}</span> (${typeNumber})${tiedTypes && tiedTypes.length > 1 ? ` <small style="color:var(--text-muted-color);">(√âgalit√© possible avec ${tiedTypes.filter(t=>t!==mainType).join(', ')})</small>` : ''}`;

                     let wingsText = "Aile(s) potentielle(s) : ";
                     if (wings.length > 0) wingsText += wings.map(w => `${w} (${enneagramData[w].name})`).join(' et ');
                     else { const w1 = mainType === 1 ? 9 : mainType - 1, w2 = mainType === 9 ? 1 : mainType + 1; wingsText = `Consid√©rez influences des types ${w1} et ${w2}. (Ailes non marqu√©es)`; }
                     wingsInfoP.textContent = wingsText;
                     viewDetailsBtn.onclick = () => displayTypeDetails(mainType); viewDetailsBtn.disabled = false;
                 } else {
                     resultSummaryH2.innerHTML = `Votre type principal probable : <span id="main-type-name">Ind√©termin√©</span> (<span id="main-type-number">?</span>)`;
                     wingsInfoP.textContent = "Impossible de d√©terminer. Veuillez r√©pondre √† plus de questions."; viewDetailsBtn.disabled = true;
                 }

                 resultsChartDiv.innerHTML = '';
                 let maxScoreValue = 0;
                 for (const type in scores) { const numScore = Number(scores[type] || 0); if (!isNaN(numScore) && numScore > maxScoreValue) maxScoreValue = numScore; }
                 if (maxScoreValue <= 0) maxScoreValue = 1;
                 for (let i = 1; i <= 9; i++) {
                     const score = scores[i] || 0; const numScore = Number(score); if (isNaN(numScore)) continue;
                     const barHeight = Math.max(0, Math.min(100, (numScore / maxScoreValue) * 100));
                     const barContainer = document.createElement('div'); barContainer.className = 'chart-bar-container';
                     const bar = document.createElement('div'); bar.className = `chart-bar type-bg-${i}`; bar.style.height = `${barHeight}%`; bar.dataset.score = numScore;
                     const label = document.createElement('div'); label.className = 'chart-label'; label.textContent = i;
                     barContainer.append(bar, label); resultsChartDiv.appendChild(barContainer);
                 }
                 showView('results');
            }

             function resetTestAndShowHome() { /* (No changes needed) */
                 userResult = null; userAnswers = {}; scores = {};
                 localStorage.removeItem('enneagramResult');
                 savedResultInfo.style.display = 'none';
                 navigationHistory = ['home']; // Reset history
                 showView('home');
             }


            // --- Types Functions ---
            function populateTypeSelection() {
                 typeSelectionDiv.innerHTML = '';
                 for (let i = 1; i <= 9; i++) {
                     const type = enneagramData[i];
                     const button = document.createElement('button');
                     button.innerHTML = `${type.icon || i}`; button.title = type.name;
                     button.className = `type-button outline type-color-${i}`; // Add classes
                     button.onclick = () => displayTypeDetails(i);
                     typeSelectionDiv.appendChild(button);
                 }
                  // Ensure details are hidden when first populating
                 typeDetailContentDiv.style.display = 'none';
                 // Reset selected state
                 clearSelectedTypeButton();
             }

             function clearSelectedTypeButton() {
                 typeSelectionDiv.querySelectorAll('.type-button.selected').forEach(btn => btn.classList.remove('selected'));
             }

            function displayTypeDetails(typeNumber) {
                const type = enneagramData[typeNumber]; if (!type) return;

                 // Highlight selected button
                 clearSelectedTypeButton();
                 const selectedBtn = typeSelectionDiv.querySelector(`.type-color-${typeNumber}`);
                 if(selectedBtn) selectedBtn.classList.add('selected');

                 // Add arrows to Stress/Security
                 const stressTarget = enneagramData[type.growthPath] ? `(${type.growthPath} ${enneagramData[type.growthPath].name})` : '';
                 const securityTarget = enneagramData[type.securityPath] ? `(${type.securityPath} ${enneagramData[type.securityPath].name})` : '';

                 typeDetailContentDiv.innerHTML = `
                     <h3 class="type-text-${typeNumber}">${type.icon} ${type.name} (Type ${typeNumber})</h3>
                     <div class="type-detail-section"><h4>Description G√©n√©rale</h4><p>${type.description}</p></div>
                     <div class="type-detail-section"><h4>Forces et Talents</h4><p>${type.strengths}</p></div>
                     <div class="type-detail-section"><h4>D√©fis et Points de Vigilance</h4><p>${type.weaknesses}</p></div>
                     <div class="type-detail-section"><h4>Motivations Profondes et Peurs</h4><p><strong>Motivation:</strong> ${type.motivation}<br><strong>Peur:</strong> ${type.fear}</p></div>
                     <div class="type-detail-section">
                        <h4>Dynamiques (Stress/S√©curit√©)</h4>
                        <p><strong>Stress (D√©sint√©gration) <span style="color: var(--danger-color)">‚ûî</span> ${stressTarget}:</strong> ${type.stress}</p>
                        <p><strong>S√©curit√© (Int√©gration) <span style="color: var(--success-color)">‚ûî</span> ${securityTarget}:</strong> ${type.security}</p>
                    </div>
                     <div class="type-detail-section"><h4>Chemins de Croissance</h4><p>${type.growth}</p></div>
                     <div class="type-detail-section"><h4>Conseils Pratiques</h4><p>${type.tips || "Conseils sp√©cifiques √† venir."}</p></div>
                     <div id="hide-details-btn-container">
                          <button id="hide-details-btn" class="outline">Retour √† la s√©lection</button>
                     </div>
                 `;
                 // Re-add event listener for the new button
                 document.getElementById('hide-details-btn').addEventListener('click', hideTypeDetails);


                 // Apply colored border using class
                 typeDetailContentDiv.className = ''; // Clear previous border classes
                 typeDetailContentDiv.classList.add(`type-border-${typeNumber}`);

                 typeDetailContentDiv.style.display = 'block';
                 // Scroll into view smoothly
                  typeDetailContentDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                 // Ensure the main view remains 'types'
                 if (currentView !== 'types') { showView('types'); }
             }

             // === AJOUT : Function to hide details within the types view ===
             function hideTypeDetails() {
                 typeDetailContentDiv.style.display = 'none';
                 clearSelectedTypeButton(); // Unselect the button
                 // Optional: scroll back to the selection area
                  typeSelectionDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
             }
             // === FIN AJOUT ===


             // --- Comparison Functions ---
            function populateComparisonSelectors() { /* (No changes needed) */
                compareType1Select.innerHTML = '<option value="">Choisir Type 1</option>';
                compareType2Select.innerHTML = '<option value="">Choisir Type 2</option>';
                for (let i = 1; i <= 9; i++) {
                    const opt1 = document.createElement('option'); opt1.value = i; opt1.textContent = `Type ${i}: ${enneagramData[i].name}`; compareType1Select.appendChild(opt1);
                    const opt2 = document.createElement('option'); opt2.value = i; opt2.textContent = `Type ${i}: ${enneagramData[i].name}`; compareType2Select.appendChild(opt2);
                }
            }
            function compareTypes() { /* (No changes needed) */
                const t1 = compareType1Select.value, t2 = compareType2Select.value;
                if (!t1 || !t2) { comparisonResultDiv.innerHTML = "<p style='color: var(--danger-color); text-align:center;'>Veuillez s√©lectionner deux types.</p>"; return; }
                const key = t1 === t2 ? `${t1}-${t1}` : `${Math.min(t1, t2)}-${Math.max(t1, t2)}`;
                const dynamic = relationshipMatrix[key];
                if (dynamic) {
                    comparisonResultDiv.innerHTML = `<h4>Dynamique Type ${t1} & Type ${t2}</h4><p>${dynamic}</p><p><em>Note : Aper√ßu simplifi√©. Les relations r√©elles sont complexes.</em></p>`;
                } else { comparisonResultDiv.innerHTML = `<p>Dynamique sp√©cifique Type ${t1} & Type ${t2} non d√©taill√©e.</p>`; }
            }

            // ---=== INITIALIZATION ===---
            function init() {
                 if (loadFromLocalStorage()) {
                     savedResultInfo.style.display = 'block';
                     showSavedResultBtn.onclick = () => displayResults();
                     clearSavedResultBtn.onclick = () => {
                         if (confirm("Voulez-vous vraiment effacer votre r√©sultat sauvegard√© ?")) {
                             localStorage.removeItem('enneagramResult');
                             savedResultInfo.style.display = 'none';
                             userResult = null; // Clear in memory too
                         }
                     };
                 } else { savedResultInfo.style.display = 'none'; }

                 // Setup Event Listeners
                 startTestBtn.addEventListener('click', startTest);
                 viewTypesBtn.addEventListener('click', () => { populateTypeSelection(); showView('types'); });
                 viewComparisonBtn.addEventListener('click', () => { populateComparisonSelectors(); comparisonResultDiv.innerHTML = ''; showView('comparison'); });
                 prevBtn.addEventListener('click', previousQuestions);
                 nextBtn.addEventListener('click', nextQuestions);
                 finishBtn.addEventListener('click', calculateResults);
                 compareBtn.addEventListener('click', compareTypes);

                 // === MODIFICATION : Setup specific back buttons ===
                 typesBackBtn.addEventListener('click', goBack);
                 // Comparison back button onclick is set directly to showView('home') in HTML
                 // Type details back button (hide-details-btn) listener is added dynamically in displayTypeDetails

                 // Initial View (handled by class="active" in HTML)
                 currentViewTarget = document.querySelector('.view.active');
                 if(!currentViewTarget) showView('home'); // Fallback if no active class initially
            }

            // ---=== START THE APP ===---
            init();
        });
    </script>
</body>
</html>
