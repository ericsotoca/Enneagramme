<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Découvrez votre Ennéagramme</title>
    <style>
        /* --- Reset & Base Styles --- */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --background-color: #f8f9fa;
            --text-color: #333;
            --light-gray: #e9ecef;
            --medium-gray: #ced4da;
            --dark-gray: #6c757d;
            --white: #fff;
            --danger-color: #dc3545;

            /* Type Colors (Examples) */
            --type1-color: #d9534f;
            --type2-color: #f0ad4e;
            --type3-color: #5cb85c;
            --type4-color: #5bc0de;
            --type5-color: #0275d8;
            --type6-color: #292b2c;
            --type7-color: #f7e14f;
            --type8-color: #8d6e63;
            --type9-color: #a1887f;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            padding: 20px 10px;
            min-height: 100vh;
        }

        #app {
            background-color: var(--white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            overflow: hidden; /* Contient les flottants ou marges */
        }

        h1, h2, h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
            text-align: center;
        }
        h3 {
            color: var(--dark-gray);
            margin-top: 1.5rem;
        }

        p {
            margin-bottom: 1rem;
        }

        button {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
            margin: 5px;
        }

        button:hover {
            background-color: #357abd;
        }

        button.secondary {
            background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #d48f1c;
        }
        
        button.outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        button.outline:hover {
            background-color: var(--light-gray);
        }

        button:disabled {
            background-color: var(--medium-gray);
            cursor: not-allowed;
        }

        /* --- View Management --- */
        .view {
            display: none; /* Hide all views by default */
        }
        .view.active {
            display: block; /* Show the active view */
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- Home --- */
        #home {
            text-align: center;
        }
        #home .actions {
            margin-top: 2rem;
        }

        /* --- Test --- */
        #test-progress-container {
            width: 100%;
            background-color: var(--light-gray);
            border-radius: 5px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        #test-progress {
            height: 10px;
            width: 0%;
            background-color: var(--secondary-color);
            transition: width 0.3s ease;
        }
        #question-container {
            margin-bottom: 1.5rem;
            min-height: 200px; /* Avoid layout jumps */
        }
        .question-item {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }
        .question-item p {
            font-weight: bold;
            margin-bottom: 0.8rem;
        }
        .likert-scale {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px; /* Espacement entre les boutons radio */
        }
        .likert-scale label {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--dark-gray);
            padding: 5px;
            border: 1px solid transparent; /* Pour la stabilité de la mise en page */
            border-radius: 4px;
            min-width: 60px; /* Assure une largeur minimale */
        }
        .likert-scale input[type="radio"] {
            margin-bottom: 5px;
            accent-color: var(--primary-color); /* Style la couleur du bouton radio sélectionné */
        }
        .likert-scale input[type="radio"]:checked + span {
             font-weight: bold;
             color: var(--primary-color);
        }
        /* Styles pour mobile */
        @media (max-width: 600px) {
            .likert-scale {
                justify-content: center; /* Centre les options sur petit écran */
            }
             .likert-scale label {
                min-width: 50px;
                 font-size: 0.8rem;
             }
        }


        #test-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        /* --- Results --- */
        #results-summary {
            text-align: center;
            margin-bottom: 2rem;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 5px;
        }
         #results-summary h2 {
             margin-bottom: 0.5rem;
         }
        #results-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 200px;
            border-bottom: 1px solid var(--medium-gray);
            padding-bottom: 10px;
            margin-bottom: 2rem;
        }
        .chart-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 8%; /* Ajusté pour 9 barres + espacement */
            text-align: center;
        }
        .chart-bar {
            width: 100%;
            background-color: var(--primary-color);
            transition: height 0.5s ease-out;
            border-radius: 3px 3px 0 0;
            position: relative; /* Pour le tooltip */
        }
        .chart-bar::after { /* Tooltip pour score */
            content: attr(data-score);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-gray);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .chart-bar:hover::after {
            opacity: 1;
        }

        .chart-label {
            margin-top: 5px;
            font-size: 0.8rem;
            color: var(--dark-gray);
        }
        #results-actions {
            text-align: center;
            margin-top: 1.5rem;
        }

        /* --- Types --- */
        #type-selection {
            text-align: center;
            margin-bottom: 2rem;
            display: flex; /* Pour utiliser gap */
            flex-wrap: wrap; /* Permet aux boutons de passer à la ligne */
            justify-content: center; /* Centre les boutons */
            gap: 10px; /* Espace entre les boutons */
        }
        .type-button {
            padding: 8px 12px;
            min-width: 40px; /* Pour une apparence carrée/ronde */
        }
        #type-detail-content {
            margin-top: 1.5rem;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
        }
        #type-detail-content h3:first-child {
            margin-top: 0; /* Pas de marge en haut pour le premier titre */
        }
        .type-detail-section {
            margin-bottom: 1rem;
        }
        .type-detail-section h4 {
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 0.2rem;
        }

        /* --- Comparison --- */
        #comparison-selectors {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 15px;
            flex-wrap: wrap; /* Pour mobile */
        }
        #comparison-selectors label {
            margin-right: 5px;
            font-weight: bold;
        }
        #comparison-selectors select {
            padding: 8px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            min-width: 150px; /* Donne de l'espace */
        }
        #comparison-result {
            margin-top: 1.5rem;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 5px;
            min-height: 50px; /* Pour éviter les sauts de layout */
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 600px) {
            body {
                padding: 10px 5px;
            }
            #app {
                padding: 15px;
            }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.5rem; }
            button { padding: 8px 15px; font-size: 0.9rem; }

            #results-chart {
                height: 150px;
            }
             .chart-bar-container {
                 width: 10%; /* Ajustement pour petit écran */
             }
            .chart-label {
                 font-size: 0.7rem;
             }

            #comparison-selectors {
                flex-direction: column;
                align-items: stretch; /* Prend toute la largeur */
            }
            #comparison-selectors select {
                 width: 100%; /* Pleine largeur sur mobile */
                 margin-top: 5px;
            }
        }

        /* Type specific colors */
        .type-color-1 { color: var(--type1-color); border-color: var(--type1-color); }
        .type-color-2 { color: var(--type2-color); border-color: var(--type2-color); }
        .type-color-3 { color: var(--type3-color); border-color: var(--type3-color); }
        .type-color-4 { color: var(--type4-color); border-color: var(--type4-color); }
        .type-color-5 { color: var(--type5-color); border-color: var(--type5-color); }
        .type-color-6 { color: var(--type6-color); border-color: var(--type6-color); }
        .type-color-7 { color: var(--type7-color); border-color: var(--type7-color); }
        .type-color-8 { color: var(--type8-color); border-color: var(--type8-color); }
        .type-color-9 { color: var(--type9-color); border-color: var(--type9-color); }

        .type-bg-1 { background-color: var(--type1-color) !important; }
        .type-bg-2 { background-color: var(--type2-color) !important; }
        .type-bg-3 { background-color: var(--type3-color) !important; }
        .type-bg-4 { background-color: var(--type4-color) !important; }
        .type-bg-5 { background-color: var(--type5-color) !important; }
        .type-bg-6 { background-color: var(--type6-color) !important; }
        .type-bg-7 { background-color: var(--type7-color) !important; }
        .type-bg-8 { background-color: var(--type8-color) !important; }
        .type-bg-9 { background-color: var(--type9-color) !important; }


    </style>
</head>
<body>
    <div id="app">
        <!-- ==== HOME VIEW ==== -->
        <section id="home" class="view active">
            <h1>Bienvenue sur l'Explorateur d'Ennéagramme</h1>
            <p>L'Ennéagramme est un système d'étude de la personnalité basé sur neuf types distincts. Découvrez le vôtre pour mieux vous comprendre et améliorer vos relations.</p>
            <div class="actions">
                <button id="start-test-btn">Démarrer le Test</button>
                <button id="view-types-btn" class="secondary">Voir les 9 Types</button>
                 <button id="view-comparison-btn" class="outline">Comparer les Types</button>
            </div>
             <div id="saved-result-info" style="margin-top: 20px; font-size: 0.9em; color: var(--dark-gray); display: none;">
                <p>Un résultat précédent a été trouvé.</p>
                <button id="show-saved-result-btn" class="outline">Afficher mon résultat sauvegardé</button>
            </div>
        </section>

        <!-- ==== TEST VIEW ==== -->
        <section id="test" class="view">
            <h2>Questionnaire Ennéagramme</h2>
            <div id="test-progress-container">
                <div id="test-progress"></div>
            </div>
            <p><span id="current-q-number">1</span> / <span id="total-q-number"></span></p>
            <div id="question-container">
                <!-- Questions will be loaded here -->
            </div>
            <div id="test-navigation">
                <button id="prev-btn" disabled>Précédent</button>
                <button id="next-btn">Suivant</button>
                 <button id="finish-btn" style="display: none;">Terminer</button>
            </div>
             <button onclick="showView('home')" class="outline" style="margin-top: 15px;">Abandonner & Retour Accueil</button>
        </section>

        <!-- ==== RESULTS VIEW ==== -->
        <section id="results" class="view">
            <h2>Vos Résultats</h2>
            <div id="results-summary">
                 <h2>Votre type principal probable : <span id="main-type-name"></span> (<span id="main-type-number"></span>)</h2>
                 <p id="wings-info"></p>
            </div>

            <h3>Scores par type :</h3>
            <div id="results-chart">
                <!-- Chart bars will be generated here -->
            </div>

            <div id="results-actions">
                <button id="view-details-btn">Voir les détails de mon type</button>
                <button onclick="showView('types')" class="secondary">Explorer les autres types</button>
                <button onclick="resetTestAndShowHome()" class="outline">Refaire le test</button>
            </div>
        </section>

        <!-- ==== TYPES VIEW ==== -->
        <section id="types" class="view">
            <h2>Les 9 Types de l'Ennéagramme</h2>
            <div id="type-selection">
                <!-- Type selection buttons will be generated here -->
            </div>
            <div id="type-detail-content" style="display: none;">
                <!-- Type details will be loaded here -->
            </div>
             <button onclick="goBackToPreviousViewOrHome()" class="outline" style="margin-top: 20px;">Retour</button>
        </section>

         <!-- ==== COMPARISON VIEW ==== -->
        <section id="comparison" class="view">
            <h2>Comparaison Relationnelle</h2>
            <p>Sélectionnez deux types pour voir un aperçu de leur dynamique relationnelle.</p>
             <div id="comparison-selectors">
                 <div>
                    <label for="compare-type1">Type 1:</label>
                    <select id="compare-type1">
                        <!-- Options generated by JS -->
                    </select>
                 </div>
                 <div>
                     <label for="compare-type2">Type 2:</label>
                    <select id="compare-type2">
                         <!-- Options generated by JS -->
                    </select>
                 </div>
            </div>
            <button id="compare-btn" class="primary">Comparer</button>

            <div id="comparison-result">
                <!-- Comparison result shown here -->
            </div>
            <button onclick="showView('home')" class="outline" style="margin-top: 20px;">Retour à l'accueil</button>
        </section>

    </div>

    <script>
        // Wrap all code in DOMContentLoaded to ensure HTML is ready
        document.addEventListener('DOMContentLoaded', () => {

            // ---=== DATABASE ===---
            const enneagramData = {
                1: { name: "Le Perfectionniste", color: "var(--type1-color)", icon: "🎯", description: "Principlé, déterminé, contrôlé et perfectionniste.", strengths: "Éthique, fiable, productif, sage, idéaliste.", weaknesses: "Critique, jugement, rigidité, ressentiment.", motivation: "Être bon, avoir raison, être juste.", fear: "Être corrompu, mauvais, défectueux.", stress: "Devient critique et moralisateur (comme un 4 malsain).", security: "Se détend et devient plus spontané (comme un 7 sain).", growth: "Accepter l'imperfection, cultiver la sérénité, développer l'empathie.", tips: "Pratiquer la pleine conscience, célébrer les petites victoires, déléguer." },
                2: { name: "L'Altruiste", color: "var(--type2-color)", icon: "❤️", description: "Attentionné, généreux, possessif et manipulateur.", strengths: "Aimant, attentionné, généreux, empathique.", weaknesses: "Orgueilleux, dépendant, manipulateur (indirectement).", motivation: "Être aimé, être nécessaire.", fear: "Ne pas être aimé, ne pas être voulu.", stress: "Devient agressif et autoritaire (comme un 8 malsain).", security: "Devient plus conscient de ses propres besoins (comme un 4 sain).", growth: "Reconnaître ses propres besoins, fixer des limites saines, aimer sans attente.", tips: "Tenir un journal de ses besoins, apprendre à dire non, pratiquer l'auto-compassion." },
                3: { name: "Le Battant", color: "var(--type3-color)", icon: "⭐", description: "Orienté succès, adaptable, excellent, mais vaniteux et superficiel.", strengths: "Ambitieux, efficace, confiant, énergique.", weaknesses: "Compétitif à l'excès, workaholic, vaniteux, peur de l'échec.", motivation: "Être valorisé, admiré, avoir du succès.", fear: "Ne pas avoir de valeur, échouer.", stress: "Se replie et devient apathique (comme un 9 malsain).", security: "Devient plus coopératif et authentique (comme un 6 sain).", growth: "Cultiver l'authenticité, valoriser les relations, ralentir.", tips: "Identifier ses vraies valeurs, passer du temps de qualité sans objectif, pratiquer l'humilité." },
                4: { name: "Le Romantique", color: "var(--type4-color)", icon: "🎨", description: "Introspectif, expressif, dramatique et réservé.", strengths: "Créatif, sensible, introspectif, authentique.", weaknesses: "Lunatique, mélancolique, auto-absorbé, envieux.", motivation: "Être unique, authentique, compris.", fear: "Ne pas avoir d'identité, être insignifiant.", stress: "Devient trop dépendant et en demande (comme un 2 malsain).", security: "Devient plus objectif et principiel (comme un 1 sain).", growth: "Apprécier le présent, cultiver la gratitude, agir malgré l'humeur.", tips: "Pratiquer la gratitude quotidienne, s'engager dans des actions concrètes, équilibrer émotion et raison." },
                5: { name: "L'Observateur", color: "var(--type5-color)", icon: "🧠", description: "Perspicace, innovant, secret et isolé.", strengths: "Analytique, curieux, indépendant, objectif.", weaknesses: "Détaché, avare (temps, énergie), isolé, cynique.", motivation: "Être compétent, capable, savoir.", fear: "Être inutile, incapable, envahi.", stress: "Devient hyperactif et dispersé (comme un 7 malsain).", security: "Devient plus confiant et engagé (comme un 8 sain).", growth: "S'engager avec le monde, partager ses ressources, connecter corps et esprit.", tips: "Pratiquer l'incarnation (sport, danse), fixer des limites au temps de recherche, partager ses découvertes." },
                6: { name: "Le Loyaliste", color: "var(--type6-color)", icon: "🛡️", description: "Engagé, responsable, anxieux et méfiant.", strengths: "Loyal, responsable, travailleur, prévoyant.", weaknesses: "Anxieux, indécis, méfiant, pessimiste.", motivation: "Avoir sécurité et soutien.", fear: "Être sans soutien, abandonné, incapable de survivre seul.", stress: "Devient compétitif et arrogant (comme un 3 malsain).", security: "Devient plus détendu et optimiste (comme un 9 sain).", growth: "Faire confiance à soi-même, gérer l'anxiété, accepter l'incertitude.", tips: "Identifier les scénarios catastrophes vs réalités, pratiquer la prise de décision, chercher des preuves de soutien." },
                7: { name: "L'Épicurien", color: "var(--type7-color)", icon: "🎉", description: "Occupé, productif, spontané, mais dispersé et excessif.", strengths: "Optimiste, énergique, curieux, spontané.", weaknesses: "Superficiel, impulsif, dispersé, évite la douleur.", motivation: "Être satisfait, content, éviter la souffrance.", fear: "Être privé, piégé dans la souffrance.", stress: "Devient critique et perfectionniste (comme un 1 malsain).", security: "Devient plus concentré et profond (comme un 5 sain).", growth: "Accepter la douleur et l'ennui, s'engager en profondeur, trouver la joie dans le simple.", tips: "Pratiquer la pleine conscience, terminer les projets commencés, explorer les émotions difficiles." },
                8: { name: "Le Protecteur", color: "var(--type8-color)", icon: "👑", description: "Puissant, dominant, assertif, mais contrôlant et intimidant.", strengths: "Protecteur, décisif, volontaire, énergique.", weaknesses: "Contrôlant, dominateur, insensible, vengeur.", motivation: "Se protéger, contrôler son environnement.", fear: "Être contrôlé, blessé, faible.", stress: "Se retire et devient craintif (comme un 5 malsain).", security: "Devient plus attentionné et ouvert (comme un 2 sain).", growth: "Développer la vulnérabilité, utiliser sa force pour les autres, écouter.", tips: "Pratiquer l'écoute active, reconnaître l'impact de sa force, exprimer sa vulnérabilité dans un cadre sûr." },
                9: { name: "Le Médiateur", color: "var(--type9-color)", icon: "☮️", description: "Paisible, rassurant, agréable, mais complaisant et têtu.", strengths: "Accommodant, diplomate, patient, stable.", weaknesses: "Procrastinateur, indécis, passif-agressif, têtu.", motivation: "Maintenir la paix intérieure et l'harmonie extérieure.", fear: "Perte, séparation, conflit.", stress: "Devient anxieux et inquiet (comme un 6 malsain).", security: "Devient plus affirmé et orienté objectifs (comme un 3 sain).", growth: "S'affirmer, reconnaître sa propre colère, définir ses priorités.", tips: "Identifier ses propres désirs, pratiquer l'affirmation de soi (petits pas), reconnaître et exprimer la colère de manière saine." }
            };

            // Simplified questions - NEED MORE (45-60) for a real test
             // Structure: { id: number, text: string, type: number (associated enneagram type) }
            const questions = [
                 // Type 1
                { id: 1, text: "J'ai des principes forts et je m'efforce de les respecter.", type: 1 },
                { id: 2, text: "Je suis souvent critique envers moi-même ou les autres quand les choses ne sont pas bien faites.", type: 1 },
                { id: 3, text: "L'organisation et l'ordre sont importants pour moi.", type: 1 },
                 // Type 2
                { id: 4, text: "J'aime aider les autres et me sentir nécessaire.", type: 2 },
                { id: 5, text: "J'ai parfois du mal à reconnaître mes propres besoins.", type: 2 },
                { id: 6, text: "Exprimer ma gratitude et mon affection est naturel pour moi.", type: 2 },
                // Type 3
                { id: 7, text: "Le succès et la reconnaissance sont des moteurs importants pour moi.", type: 3 },
                { id: 8, text: "Je suis efficace et j'aime atteindre mes objectifs.", type: 3 },
                { id: 9, text: "Je m'adapte facilement pour plaire ou impressionner.", type: 3 },
                 // Type 4
                { id: 10, text: "Je me sens souvent différent des autres, unique.", type: 4 },
                { id: 11, text: "Mes émotions sont intenses et importantes pour moi.", type: 4 },
                { id: 12, text: "Je recherche l'authenticité et la profondeur dans ma vie.", type: 4 },
                // Type 5
                { id: 13, text: "J'ai besoin de comprendre le monde qui m'entoure en détail.", type: 5 },
                { id: 14, text: "J'apprécie mon temps seul pour réfléchir et recharger mes batteries.", type: 5 },
                { id: 15, text: "Je préfère observer avant de participer.", type: 5 },
                // Type 6
                { id: 16, text: "La sécurité et la loyauté sont très importantes pour moi.", type: 6 },
                { id: 17, text: "J'ai tendance à imaginer les pires scénarios possibles.", type: 6 },
                { id: 18, text: "Je cherche souvent l'avis des autres avant de prendre une décision.", type: 6 },
                // Type 7
                { id: 19, text: "J'aime explorer de nouvelles options et expériences.", type: 7 },
                { id: 20, text: "J'essaie d'éviter les sentiments négatifs et la douleur.", type: 7 },
                { id: 21, text: "Je suis généralement optimiste et plein d'énergie.", type: 7 },
                // Type 8
                { id: 22, text: "Je prends les devants et n'hésite pas à exprimer mon opinion.", type: 8 },
                { id: 23, text: "Je protège les personnes qui me sont chères.", type: 8 },
                { id: 24, text: "J'aime avoir le contrôle des situations.", type: 8 },
                // Type 9
                { id: 25, text: "Je cherche à éviter les conflits et à maintenir l'harmonie.", type: 9 },
                { id: 26, text: "J'ai parfois du mal à savoir ce que je veux vraiment.", type: 9 },
                { id: 27, text: "Je peux voir tous les points de vue dans une situation.", type: 9 },
                // Add more questions here... (target 45-60 total)
            ];

             // Simplified relationship dynamics - Needs expert input
            const relationshipMatrix = {
                "1-1": "Partage de valeurs, risque de critiques mutuelles.",
                "1-2": "Le 1 apprécie l'aide du 2, le 2 peut se sentir critiqué.",
                "1-7": "Complémentaires (structure/fun), mais le 1 peut juger le 7 d'irresponsable.",
                 "2-8": "Le 2 admire la force du 8, le 8 apprécie le soutien du 2, risque de contrôle.",
                 "4-9": "Le 4 cherche l'intensité, le 9 la paix ; compréhension mutuelle possible mais nécessite des efforts.",
                 // Add many more combinations... default message otherwise
            };

             // ---=== APPLICATION STATE ===---
            let currentView = 'home';
            let currentQuestionIndex = 0;
            const questionsPerPage = 5;
            let userAnswers = {}; // { questionId: score }
            let scores = {}; // { typeNumber: totalScore }
            let userResult = null; // { mainType: number, wings: [num], scores: {} }
             let previousView = 'home'; // To handle back button logic


            // ---=== DOM ELEMENTS ===---
            const views = document.querySelectorAll('.view');
            const appContainer = document.getElementById('app');

            // Home
            const startTestBtn = document.getElementById('start-test-btn');
            const viewTypesBtn = document.getElementById('view-types-btn');
            const viewComparisonBtn = document.getElementById('view-comparison-btn');
            const savedResultInfo = document.getElementById('saved-result-info');
            const showSavedResultBtn = document.getElementById('show-saved-result-btn');

            // Test
            const testView = document.getElementById('test');
            const questionContainer = document.getElementById('question-container');
            const progressBar = document.getElementById('test-progress');
             const currentQNumberSpan = document.getElementById('current-q-number');
            const totalQNumberSpan = document.getElementById('total-q-number');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const finishBtn = document.getElementById('finish-btn');

            // Results
            const resultsView = document.getElementById('results');
            const mainTypeNameSpan = document.getElementById('main-type-name');
            const mainTypeNumberSpan = document.getElementById('main-type-number');
            const wingsInfoP = document.getElementById('wings-info');
            const resultsChartDiv = document.getElementById('results-chart');
            const viewDetailsBtn = document.getElementById('view-details-btn');

            // Types
            const typesView = document.getElementById('types');
            const typeSelectionDiv = document.getElementById('type-selection');
            const typeDetailContentDiv = document.getElementById('type-detail-content');

            // Comparison
            const comparisonView = document.getElementById('comparison');
            const compareType1Select = document.getElementById('compare-type1');
            const compareType2Select = document.getElementById('compare-type2');
            const compareBtn = document.getElementById('compare-btn');
            const comparisonResultDiv = document.getElementById('comparison-result');


            // ---=== FUNCTIONS ===---

            function showView(viewId) {
                previousView = currentView; // Store the view we are coming from
                views.forEach(view => {
                    view.classList.remove('active');
                });
                const activeView = document.getElementById(viewId);
                if (activeView) {
                    activeView.classList.add('active');
                    currentView = viewId;
                    window.scrollTo(0, 0); // Scroll to top on view change
                } else {
                    console.error("View not found:", viewId);
                     // Fallback to home if view not found
                    document.getElementById('home').classList.add('active');
                    currentView = 'home';
                }
            }

            function goBackToPreviousViewOrHome() {
                // Simple back logic, goes to previous view unless it was test
                 if (previousView && previousView !== 'test' && previousView !== currentView) {
                    showView(previousView);
                } else if (userResult) {
                     showView('results'); // Go to results if test was completed
                 }
                else {
                    showView('home'); // Default fallback
                }
            }


            // --- Test Functions ---
             function startTest() {
                currentQuestionIndex = 0;
                userAnswers = {};
                scores = {};
                userResult = null; // Clear previous result
                localStorage.removeItem('enneagramResult'); // Clear saved result on new test
                totalQNumberSpan.textContent = questions.length;
                displayCurrentQuestions();
                updateProgress();
                showView('test');
                 // Ensure finish button is hidden initially, next button is visible
                 nextBtn.style.display = 'inline-block';
                 finishBtn.style.display = 'none';
            }

            function displayCurrentQuestions() {
                 questionContainer.innerHTML = ''; // Clear previous questions
                const start = currentQuestionIndex;
                const end = Math.min(start + questionsPerPage, questions.length);
                currentQNumberSpan.textContent = start + 1; // Display starting question number of the page

                for (let i = start; i < end; i++) {
                    const q = questions[i];
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('question-item');
                    questionDiv.innerHTML = `
                        <p>${i + 1}. ${q.text}</p>
                        <div class="likert-scale" data-question-id="${q.id}">
                            <label> <input type="radio" name="q${q.id}" value="1"> <span>Pas du tout<br>d'accord</span> </label>
                            <label> <input type="radio" name="q${q.id}" value="2"> <span>Plutôt pas<br>d'accord</span> </label>
                            <label> <input type="radio" name="q${q.id}" value="3"> <span>Neutre</span> </label>
                            <label> <input type="radio" name="q${q.id}" value="4"> <span>Plutôt<br>d'accord</span> </label>
                            <label> <input type="radio" name="q${q.id}" value="5"> <span>Tout à fait<br>d'accord</span> </label>
                        </div>
                    `;
                    questionContainer.appendChild(questionDiv);

                    // Restore previous answer if exists for this question
                    if (userAnswers[q.id]) {
                         const savedAnswerInput = questionDiv.querySelector(`input[name="q${q.id}"][value="${userAnswers[q.id]}"]`);
                        if(savedAnswerInput) savedAnswerInput.checked = true;
                    }
                 }

                 // Add event listener using delegation on the container
                 questionContainer.removeEventListener('change', handleAnswerChange); // Prevent multiple listeners
                 questionContainer.addEventListener('change', handleAnswerChange);

                 updateNavigationButtons();
            }

            function handleAnswerChange(event) {
                 if (event.target.type === 'radio' && event.target.name.startsWith('q')) {
                    const questionId = parseInt(event.target.name.substring(1));
                    const score = parseInt(event.target.value);
                    userAnswers[questionId] = score;
                    // console.log(`Answered Q${questionId} with ${score}`); // For debugging
                 }
             }


             function saveCurrentPageAnswers() {
                 // This is now handled by handleAnswerChange in real-time
                 // This function could be used for validation if needed before proceeding
                 const start = currentQuestionIndex;
                 const end = Math.min(start + questionsPerPage, questions.length);
                 let allAnswered = true;
                 for (let i = start; i < end; i++) {
                     const qId = questions[i].id;
                     if (!userAnswers[qId]) {
                         allAnswered = false;
                         break;
                     }
                 }
                 if (!allAnswered) {
                     alert("Veuillez répondre à toutes les questions sur cette page.");
                     return false; // Indicate failure
                 }
                 return true; // Indicate success
             }


             function nextQuestions() {
                 // Optional: Add validation before proceeding
                 // if (!saveCurrentPageAnswers()) return;

                 currentQuestionIndex += questionsPerPage;
                if (currentQuestionIndex >= questions.length) {
                     // This case should ideally be handled by the finish button visibility
                     calculateResults();
                } else {
                    displayCurrentQuestions();
                    updateProgress();
                }
            }

            function previousQuestions() {
                // Optional: Add validation or save state if needed
                 // saveCurrentPageAnswers(); // Save answers even when going back

                currentQuestionIndex -= questionsPerPage;
                if (currentQuestionIndex < 0) {
                    currentQuestionIndex = 0; // Should not happen if button is disabled
                }
                displayCurrentQuestions();
                updateProgress();
            }

             function updateNavigationButtons() {
                 prevBtn.disabled = currentQuestionIndex === 0;

                 const isLastPage = (currentQuestionIndex + questionsPerPage) >= questions.length;
                 nextBtn.style.display = isLastPage ? 'none' : 'inline-block';
                 finishBtn.style.display = isLastPage ? 'inline-block' : 'none';
             }


            function updateProgress() {
                 // Calculate progress based on the *start* of the current page
                 const progressPercentage = Math.min(100, (currentQuestionIndex / questions.length) * 100);
                 progressBar.style.width = `${progressPercentage}%`;
            }

            function calculateResults() {
                scores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
                let answeredQuestionsCount = 0;

                for (const q of questions) {
                    if (userAnswers[q.id]) {
                         scores[q.type] += userAnswers[q.id];
                        answeredQuestionsCount++;
                     } else {
                         // Handle unanswered questions? Assume 0 or neutral (3)?
                         // For simplicity, we'll skip them, but a real test might require all answers.
                        console.warn(`Question ${q.id} not answered.`);
                     }
                }

                 // Check if enough questions were answered
                if (answeredQuestionsCount < questions.length * 0.8) { // Example threshold: 80%
                    alert("Vous n'avez pas répondu à suffisamment de questions pour un résultat fiable. Veuillez recommencer le test.");
                     showView('home');
                    return;
                }


                // Find main type (highest score)
                 let mainType = -1;
                 let maxScore = -1;
                 for (const type in scores) {
                     if (scores[type] > maxScore) {
                         maxScore = scores[type];
                         mainType = parseInt(type);
                     }
                     // Handle ties? For now, first highest wins. Could list all tied types.
                 }

                 // Determine wings
                let wings = [];
                if (mainType !== -1) {
                    const wing1Type = mainType === 1 ? 9 : mainType - 1;
                    const wing2Type = mainType === 9 ? 1 : mainType + 1;
                    const wing1Score = scores[wing1Type] || 0;
                    const wing2Score = scores[wing2Type] || 0;

                    // Simple wing logic: Add if score is relatively high (e.g., > 60% of main type score)
                     // Or just show the adjacent types and their scores
                     // Let's identify the strongest wing
                     if (wing1Score > wing2Score && wing1Score > maxScore * 0.5) { // Example threshold
                         wings.push(wing1Type);
                     } else if (wing2Score > wing1Score && wing2Score > maxScore * 0.5) {
                         wings.push(wing2Type);
                     } else if (wing1Score === wing2Score && wing1Score > maxScore * 0.5) {
                         // Both wings are equally strong
                         wings.push(wing1Type);
                         wings.push(wing2Type);
                     }
                     // Alternative: Always show both potential wings scores
                }

                 userResult = { mainType, wings, scores };
                 saveToLocalStorage();
                 displayResults();
            }

             function saveToLocalStorage() {
                 if (userResult) {
                    try {
                        localStorage.setItem('enneagramResult', JSON.stringify(userResult));
                    } catch (e) {
                        console.error("Failed to save to localStorage", e);
                        // Inform user maybe?
                    }
                 }
             }

             function loadFromLocalStorage() {
                 try {
                     const savedResult = localStorage.getItem('enneagramResult');
                     if (savedResult) {
                         userResult = JSON.parse(savedResult);
                         return true;
                     }
                 } catch (e) {
                    console.error("Failed to load from localStorage", e);
                    localStorage.removeItem('enneagramResult'); // Clear corrupted data
                }
                 return false;
             }


            // --- Results Functions ---
             function displayResults() {
                 if (!userResult) return; // Should not happen if called correctly

                 const { mainType, wings, scores } = userResult;

                 if (mainType !== -1) {
                     mainTypeNameSpan.textContent = enneagramData[mainType].name;
                     mainTypeNumberSpan.textContent = mainType;
                     mainTypeNameSpan.className = `type-color-${mainType}`; // Add color class

                     let wingsText = "Aile(s) potentielle(s) : ";
                     if (wings.length > 0) {
                         wingsText += wings.map(w => `${w} (${enneagramData[w].name})`).join(', ');
                     } else {
                        // Determine adjacent types even if not strong wings
                        const wing1Type = mainType === 1 ? 9 : mainType - 1;
                        const wing2Type = mainType === 9 ? 1 : mainType + 1;
                        wingsText += `Considérez les influences des types ${wing1Type} et ${wing2Type}.`;
                    }
                     wingsInfoP.textContent = wingsText;

                     viewDetailsBtn.onclick = () => displayTypeDetails(mainType);
                     viewDetailsBtn.disabled = false;
                 } else {
                     mainTypeNameSpan.textContent = "Indéterminé";
                     mainTypeNumberSpan.textContent = "?";
                     wingsInfoP.textContent = "Impossible de déterminer le type principal. Essayez de refaire le test.";
                     viewDetailsBtn.disabled = true;
                 }

                 // Display Chart
                 resultsChartDiv.innerHTML = ''; // Clear previous chart
                 let maxScoreValue = 0;
                 for (const type in scores) {
                     if (scores[type] > maxScoreValue) {
                         maxScoreValue = scores[type];
                     }
                 }
                 // Avoid division by zero if all scores are 0
                 if (maxScoreValue === 0) maxScoreValue = 1;

                 for (let i = 1; i <= 9; i++) {
                     const score = scores[i] || 0;
                     const barHeight = (score / maxScoreValue) * 100; // Percentage height
                     const barContainer = document.createElement('div');
                     barContainer.classList.add('chart-bar-container');

                     const bar = document.createElement('div');
                     bar.classList.add('chart-bar');
                     // Add type-specific background color using class
                     bar.classList.add(`type-bg-${i}`);
                     bar.style.height = `${barHeight}%`;
                     bar.setAttribute('data-score', score); // For tooltip

                     const label = document.createElement('div');
                     label.classList.add('chart-label');
                     label.textContent = i;

                     barContainer.appendChild(bar);
                     barContainer.appendChild(label);
                     resultsChartDiv.appendChild(barContainer);
                 }


                 showView('results');
            }

             function resetTestAndShowHome() {
                 userResult = null;
                 userAnswers = {};
                 scores = {};
                 localStorage.removeItem('enneagramResult');
                 savedResultInfo.style.display = 'none';
                 showView('home');
             }


            // --- Types Functions ---
            function populateTypeSelection() {
                typeSelectionDiv.innerHTML = ''; // Clear existing buttons
                for (let i = 1; i <= 9; i++) {
                    const type = enneagramData[i];
                    const button = document.createElement('button');
                    button.textContent = `${i}`; // Show number, maybe add icon later
                    button.title = type.name; // Tooltip with name
                    button.classList.add('type-button', 'outline', `type-color-${i}`); // Add base and color classes
                    button.onclick = () => displayTypeDetails(i);
                    typeSelectionDiv.appendChild(button);
                }
            }

            function displayTypeDetails(typeNumber) {
                const type = enneagramData[typeNumber];
                if (!type) return;

                typeDetailContentDiv.innerHTML = `
                    <h3>${type.icon} ${type.name} (Type ${typeNumber})</h3>
                    <div class="type-detail-section">
                        <h4>Description Générale</h4>
                        <p>${type.description}</p>
                    </div>
                    <div class="type-detail-section">
                        <h4>Forces et Talents</h4>
                        <p>${type.strengths}</p>
                    </div>
                    <div class="type-detail-section">
                        <h4>Défis et Points de Vigilance</h4>
                        <p>${type.weaknesses}</p>
                    </div>
                    <div class="type-detail-section">
                        <h4>Motivations Profondes et Peurs</h4>
                        <p><strong>Motivation:</strong> ${type.motivation}<br><strong>Peur:</strong> ${type.fear}</p>
                    </div>
                    <div class="type-detail-section">
                        <h4>Comportements</h4>
                        <p><strong>Sous Stress:</strong> ${type.stress}<br><strong>En Sécurité:</strong> ${type.security}</p>
                    </div>
                     <div class="type-detail-section">
                        <h4>Chemins de Croissance Personnelle</h4>
                        <p>${type.growth}</p>
                    </div>
                     <div class="type-detail-section">
                        <h4>Conseils Pratiques</h4>
                        <p>${type.tips || "Conseils à venir."}</p>
                    </div>
                `;
                 // Apply color to the title or container background?
                 const titleH3 = typeDetailContentDiv.querySelector('h3');
                 if(titleH3) titleH3.className = `type-color-${typeNumber}`;

                typeDetailContentDiv.style.display = 'block';

                 // If not already in types view, switch to it
                 if (currentView !== 'types') {
                    showView('types');
                }

                 // Scroll to the details section
                 typeDetailContentDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }


             // --- Comparison Functions ---
             function populateComparisonSelectors() {
                 compareType1Select.innerHTML = '<option value="">Choisir Type 1</option>';
                 compareType2Select.innerHTML = '<option value="">Choisir Type 2</option>';
                 for (let i = 1; i <= 9; i++) {
                     const option1 = document.createElement('option');
                     option1.value = i;
                     option1.textContent = `Type ${i}: ${enneagramData[i].name}`;
                     compareType1Select.appendChild(option1);

                     const option2 = document.createElement('option');
                     option2.value = i;
                     option2.textContent = `Type ${i}: ${enneagramData[i].name}`;
                     compareType2Select.appendChild(option2);
                 }
             }

             function compareTypes() {
                 const type1 = compareType1Select.value;
                 const type2 = compareType2Select.value;

                 if (!type1 || !type2) {
                     comparisonResultDiv.innerHTML = "<p style='color: var(--danger-color);'>Veuillez sélectionner deux types à comparer.</p>";
                     return;
                 }
                 if (type1 === type2) {
                    comparisonResultDiv.innerHTML = "<p>Comparer un type avec lui-même ?<br> Dynamique : Partage des mêmes motivations et peurs fondamentales. Peut conduire à une grande compréhension ou à l'amplification des défis du type.</p>";
                    return;
                 }

                 // Ensure consistent key order (e.g., "1-7" not "7-1")
                 const key = `${Math.min(type1, type2)}-${Math.max(type1, type2)}`;
                 const dynamic = relationshipMatrix[key];

                 if (dynamic) {
                    comparisonResultDiv.innerHTML = `<h4>Dynamique Type ${type1} et Type ${type2}</h4><p>${dynamic}</p><p><em>Note : Ceci est une description très simplifiée. Les relations réelles sont complexes.</em></p>`;
                } else {
                    comparisonResultDiv.innerHTML = `<p>La dynamique spécifique entre le Type ${type1} et le Type ${type2} n'est pas détaillée ici. En général, tous les types peuvent avoir des relations positives en développant la conscience de soi et l'empathie.</p>`;
                 }
             }

            // ---=== INITIALIZATION ===---
            function init() {
                 // Check for saved result
                 if (loadFromLocalStorage()) {
                     savedResultInfo.style.display = 'block';
                     showSavedResultBtn.onclick = () => displayResults();
                 } else {
                     savedResultInfo.style.display = 'none';
                 }

                 // Setup Event Listeners
                 startTestBtn.addEventListener('click', startTest);
                 viewTypesBtn.addEventListener('click', () => {
                     populateTypeSelection(); // Ensure buttons are there
                     typeDetailContentDiv.style.display = 'none'; // Hide details initially
                     showView('types');
                 });
                 viewComparisonBtn.addEventListener('click', () => {
                     populateComparisonSelectors();
                     comparisonResultDiv.innerHTML = ''; // Clear previous results
                     showView('comparison');
                 });

                 prevBtn.addEventListener('click', previousQuestions);
                 nextBtn.addEventListener('click', nextQuestions);
                 finishBtn.addEventListener('click', calculateResults); // Changed from nextQuestions

                 compareBtn.addEventListener('click', compareTypes);

                 // Initial View (already set to 'home' by default)
                 showView('home');
            }

            // ---=== START THE APP ===---
            init();

        }); // End of DOMContentLoaded
    </script>
</body>
</html>
